---
title: Refresh Token ì„¤ì •í•˜ê¸°
date : 2023-08-11
id : refreshToken
tag: 
   - sharepetment
   - project
brand: project
description: refresh tokenì„ í™œìš©í•œ access tokenì„ ê°±ì‹ í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ì„œ ì •ë¦¬í•©ë‹ˆë‹¤. 
---


## ë°°ê²½

- serverì™€ ë¡œê·¸ì¸ ì •ë³´ë¥¼ ì£¼ê³ ë°›ëŠ” ë°©ë²•ìœ¼ë¡œ jwtë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ì´ˆê¸°ì—ëŠ” access tokenì˜ ë§Œë£Œì‹œê°„ì„ ë§¤ìš° ê¸¸ê²Œ ì¡ì•„ì„œ ê³„ì†í•´ì„œ ë¡œê·¸ì¸ì„ ìœ ì§€í•˜ë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤.
- ì´ëŠ” ë³´ì•ˆì„ ìƒí•˜ì˜€ì„ ë•Œ, íš¨ìœ¨ì ì´ì§€ ëª»í•œ ë°©ë²•ì´ì—ˆìŠµë‹ˆë‹¤. access tokenì„ íƒˆì·¨ ë‹¹í•œë‹¤ë©´, ì‚¬ìš©ìì˜ ì •ë³´ê°€ ë…¸ì¶œë˜ê²Œ ë©ë‹ˆë‹¤. ì´ëŸ¬í•œ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ **access tokenì˜ ë§Œë£Œ ì‹œê°„ì„ ì§§ê²Œ ì„¤ì •í•˜ê³  access tokenì´ ë§Œë£Œëœë‹¤ë©´, refresh tokenì„ í†µí•´ access tokenì„ ìƒˆë¡­ê²Œ ë°œê¸‰ ë°›ë„ë¡ ìˆ˜ì •**ì„ í•´ì•¼ í–ˆìŠµë‹ˆë‹¤.

## ë¡œì§ êµ¬ì„±í•˜ê¸°

- ì„œë²„ì—ì„œëŠ” í”„ëŸ°íŠ¸ì—ì„œ access tokenê³¼ refresh tokenì„ í•¨ê»˜ ë³´ë‚´ë©´, ìë™ìœ¼ë¡œ access tokenì„ ì¬ ì„¤ì • í•˜ë„ë¡ êµ¬í˜„ì„ í•˜ì˜€ìŠµë‹ˆë‹¤.
- ì´ë•Œ access tokenì„ ì¬ë°œê¸‰ í•˜ê¸° ìœ„í•´ì„œëŠ” access tokenì´ ë§Œë£Œë˜ê¸° ì „ì— ì¬ë°œê¸‰ì´ ì´ë£¨ì–´ì ¸ì•¼ í–ˆìŠµë‹ˆë‹¤. ì„œë²„ì—ì„œ access tokenì„ decodeí•˜ì—¬ ìœ ì € ì •ë³´ë¥¼ í™•ì¸í•˜ê³  ìƒˆë¡­ê²Œ tokenì„ ë°œê¸‰í•˜ëŠ” ë¡œì§ì„ ì‚¬ìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
- ë”°ë¼ì„œ tokenì´ ë§Œë£Œë˜ê¸° ì „ì— ë¯¸ë¦¬ tokenì„ ì¼ì • ì‹œê°„ë§ˆë‹¤ ì¬ë°œê¸‰ì„ ë°›ë„ë¡ í•´ì•¼ í–ˆìŠµë‹ˆë‹¤.
- ì¶”ê°€ì ìœ¼ë¡œ ì„œë²„ì™€ì˜ API ìš”ì²­ì—ì„œ tokenì´ í•„ìš”í•œ ìš”ì²­ì´ ë°œìƒí•˜ê¸° ì „ì— í•­ìƒ tokenì˜ ë§Œë£Œ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ëŠ” ìš”ì²­ì´ ì„ í–‰ë˜ì–´ì•¼ í–ˆìŠµë‹ˆë‹¤.

<img src="/images/refreshToken/refreshToken1.png" alt="refreshToken" width="1000" height="1000"/>

<aside>
ğŸ’¡ **ì´ì™¸ì˜ ë°©ì‹**

- ìœ„ì˜ ë°©ì‹ ì™¸ì—ë„ ìƒê°í•´ë³¼ ìˆ˜ ìˆëŠ” ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤.
    1. **client**ì—ì„œ api ìš”ì²­ì„ ë³´ë‚¸ í›„ì—Â **server**ê°€ ë§Œë£Œ ì—¬ë¶€ë¥¼ íŒŒì•…í•œ ë’¤ì— 401 responseë¥¼ ë³´ë‚´ê³ , ì‘ë‹µì„ ë°›ì€Â **client**ê°€ refresh api ìš”ì²­ì„ ë³´ë‚´ ê°±ì‹ ëœ access tokenìœ¼ë¡œ ì¬ ìš”ì²­ì„ ë³´ë‚´ëŠ” ë°©ì‹.
        
        <img src="/images/refreshToken/refreshToken2.png" alt="refreshToken" width="1000" height="1000"/>
        
    2. **clientì—ì„œ access token ë§Œë£Œ ê°€ëŠ¥ì„±ì„ í™•ì¸ í›„, ë§Œë£Œëê±°ë‚˜ ë§Œë£Œê°€ ì„ë°•í•˜ë©´ api request headerì— ì¶”ê°€ì ì¸ refresh tokenì„ ì‹¤ì–´ì„œ ë³´ë‚¸ë‹¤**. ìš”ì²­ì„ ë°›ì€Â **serverëŠ” headerì— ìœ íš¨í•œ refresh tokenì´ ì¡´ì¬í•œë‹¤ë©´ í•´ë‹¹ apiê¹Œì§€ëŠ” ì •ìƒì ì¸ ìš”ì²­ìœ¼ë¡œ ê°„ì£¼í•˜ê³  ê°±ì‹ ëœ access tokenì„ ì¶”ê°€í•˜ì—¬ ì‘ë‹µìœ¼ë¡œ ë³´ë‚´ëŠ” ë°©ì‹**.
        
        <img src="/images/refreshToken/refreshToken3.png" alt="refreshToken" width="1000" height="1000"/>
        
</aside>

## Axios interceptors

- Axiosë¥¼ http í”„ë¡œí† ì½œ ìš”ì²­ì—ì„œ í™œìš©í•˜ê³  ìˆëŠ” ìƒí™©ì—ì„œ interceptorsë¼ëŠ” ë©”ì„œë“œë¥¼ ì œê³µí•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤.
- ê³µì‹ ë¬¸ì„œì—ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì„¤ëª…í•˜ê³  ìˆìŠµë‹ˆë‹¤.
    
    > `**then`Â ë˜ëŠ”Â `catch`ë¡œ ì²˜ë¦¬ë˜ê¸° ì „ì— ìš”ì²­ê³¼ ì‘ë‹µì„ ê°€ë¡œì±Œìˆ˜ ìˆìŠµë‹ˆë‹¤.**
    > 
    
    ì¦‰ callback fnì„ í†µí•´ ìš”ì²­ì´ ì´ë£¨ì–´ì§€ê¸° ì „ì— ìš”ì²­ì„ ì„  ìˆ˜í–‰í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ì‘ì—…ì´ì—ˆìŠµë‹ˆë‹¤. node expressì˜ middlewareì™€ ìœ ì‚¬í•œ ê°œë…ì´ì—ˆìŠµë‹ˆë‹¤. 
    
- interseptorë¥¼ í™œìš©í•˜ì—¬ tokenì´ í•„ìš”í•œ ìš”ì²­ ì´ì „ì— í† í°ì˜ ë§Œë£Œì‹œê°„ì„ í™•ì¸í•˜ê³  ì´ë¥¼ ì¬ë°œê¸‰í•˜ëŠ” ìš”ì²­ì„ ì¶”ê°€ í•˜ì—¬ ë¨¼ì € ë°œìƒí•˜ë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤.

## êµ¬í˜„í•˜ê¸°

1. ìš°ì„  ë¡œê·¸ì¸ì´ ì§„í–‰ë  ë•Œ, ì„œë²„ì™€ ì•½ì†í•œ ë§Œë£Œ ì‹œê°„ì„ ê³„ì‚°í•˜ì—¬ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥í•©ë‹ˆë‹¤. ì´ë•Œ ë§Œë£Œ ì‹œê°„ì€ ì„œë²„ì˜ ë§Œë£Œ ì‹œê°„ ë³´ë‹¤ ì§§ê²Œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤. 

```tsx
import { useEffect, useContext } from 'react';
import { EXPIRED_TIME } from '@/api/axios';
import LoadingComponent from '@/components/loading/LoadingComponent';

export function Component() {
  useEffect(() => {
      // ë§Œë£Œì‹œê°„ ë¡œì»¬ì— ì €ì¥í•˜ê¸°
      const date = Date.now() + EXPIRED_TIME;

      setExpiresTime(`${date}`);
  }, [
    setExpiresTime,
  ]);

  return <LoadingComponent />;
}

Component.displayName = 'Loading';
```

1. Axios ì¸í„°ì…‰í„°ì— í™œìš©í•  í•¨ìˆ˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

```tsx
// axios.ts
/* eslint-disable @typescript-eslint/no-explicit-any */
import axios, { AxiosRequestConfig } from 'axios';
import { postTokenRefesh } from '@/api/queryfn';
import { RefreshToken } from '@/types/tokenApiType';

export const EXPIRED_TIME = 1000 * 60 * 60 * 23;

export const refresgInterceptor = async (
  config: AxiosRequestConfig,
): Promise<any> => {
  const expiresIn = window.localStorage.getItem('expiresTime');

  // ë§Œë£Œì‹œê°„ì´ ì—†ì„ ê²½ìš°
  if (expiresIn === null) return config;

  const now = Date.now();
  const expiresDate = Number(expiresIn.replace(/\D/g, '')) + EXPIRED_TIME;

  // ë§Œë£Œì‹œê°„ì´ í˜„ì¬ ì‹œê°„ë³´ë‹¤ í° ê²½ìš°

  if (expiresDate >= now) return config;

  // ë§Œë£Œì‹œê°„ë³´ë‹¤ í˜„ì¬ ì‹œê°„ì´ í° ê²½ìš°
  if (expiresDate < now) {
    window.localStorage.setItem('expiresTime', `${Date.now() + EXPIRED_TIME}`);
    const { accessToken, refreshToken } =
      (await postTokenRefesh()) as RefreshToken;
    window.localStorage.setItem('accessToken', JSON.stringify(accessToken));
    window.localStorage.setItem('refreshToken', JSON.stringify(refreshToken));

    return config;
  } else {
    return config;
  }
};

const axiosInstance = axios.create();

axiosInstance.interceptors.request.use(refresgInterceptor);

export default axiosInstance;
```

1. í† í°ì´ ë§Œë£Œë˜ì—ˆì„ ê²½ìš° í† í°ì„ ì¬ ìš”ì²­í•˜ëŠ” apië¥¼ ì‘ì„±í•©ë‹ˆë‹¤. 

```tsx
/* ------------------- accessToken ê°±ì‹  ------------------------------- */

export const postTokenRefesh = async () => {
  let refresh = window.localStorage.getItem('refreshToken')?.toString();
  let access = window.localStorage.getItem('accessToken')?.toString();
  refresh = refresh?.replace(/[''""]/g, '').slice(7) as string;
  access = access?.replace(/[''""]/g, '').slice(7) as string;

  try {
    const result = await axiosInstance.post<RefreshToken>(
      `${SERVER_URL}/refresh`,
      {
        refreshToken: refresh,
        accessToken: access,
      },
    );

    const { accessToken, refreshToken } = result.data;

    return { accessToken, refreshToken };
  } catch (err) {
    alert('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ì„ ë¶€íƒë“œë¦½ë‹ˆë‹¤. ğŸ˜¥');
    window.localStorage.removeItem('expiresTime');
    window.localStorage.removeItem('accessToken');
    window.localStorage.removeItem('refreshToken');
  }
};
```

## ë¬¸ì œ

- í•´ë‹¹ ë¡œì§ì„ í†µí•´ refresh Tokenì€ local storageì— ì €ì¥í•˜ì§€ë§Œ, access tokenì€ frontì˜ global stateë¡œ ì €ì¥í•´ì„œ ê´€ë¦¬í•´ë„ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ, **í˜„ì¬ ì„œë²„ ë¡œì§ì´ access tokenì´ ë§Œë£Œë˜ë©´, refresh tokenë§Œìœ¼ë¡œ access tokenì„ ê°±ì‹ í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì—, ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤**.
- access tokenì´ ë§Œë£Œë˜ì—ˆì„ ë•Œ, ê°±ì‹ ì´ ë˜ì–´ì•¼ í•˜ì§€ë§Œ, í˜„ì¬ëŠ” ë§Œë£Œ ì „ì— ë¯¸ë¦¬ ê°±ì‹ ì„ í•´ì•¼ í•©ë‹ˆë‹¤. ì´ëŠ” ì„œë²„ ë¶„ë“¤ê³¼ì˜ ë…¼ì˜ ì¤‘ì— í˜„ì¬ DBì— refresh tokenì´ ì €ì¥ë˜ì§€ ì•ŠëŠ” ë¬¸ì œë¡œ ì¸í•˜ì—¬ ì–´ë–¤ ìœ ì €ì˜ refresh tokenì¸ì§€ êµ¬ë¶„í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— ìƒê¸°ëŠ” ë¬¸ì œ ì¸ ê²ƒ ê°™ìŠµë‹ˆë‹¤. ë”°ë¼ì„œ **access tokenì´ ë§Œë£Œëœ ìƒí™©ì—ì„œ ìœ ì €ê°€ webì— ì ‘ì†ì„ í•œë‹¤ë©´, ë¶ˆê°€í”¼ í•˜ê²Œ ìœ ì € ì¸¡ì—ì„œ ë¡œê·¸ì¸ ê³¼ì •ì„ ì§„í–‰í•´ì•¼ í•©ë‹ˆë‹¤**.

## reference

[ì¸í„°ì…‰í„° |Â Axios Docs](https://axios-http.com/kr/docs/interceptors)

[axios interceptorsì™€ refresh tokenì„ í™œìš©í•œ jwt í† í° ê´€ë¦¬](https://gusrb3164.github.io/web/2022/08/07/refresh-with-axios-for-client/)