---
title: Nextjsì—ì„œ localStorage í™œìš©í•˜ê¸°
date: 2023-11-30
id: nextjs-localstorage
tag:
  - project
  - nextJs
  - localStorage
  - mbtmi
brand: project

description: localStorageë¥¼ ì–´ë–»ê²Œ nextJsì—ì„œ í™œìš©í• ì§€ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.
---

## localStorage ì‚¬ìš©í•˜ê¸°

Next.jsë¡œ í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ëŠ” ê³¼ì •ì—ì„œ **localStorageì— jwt í† í° ê°’**ê³¼ **ê° í˜ì´ì§€ì˜ ë°©ë¬¸ ì—¬ë¶€ë¥¼ localstorageì— ì €ì¥í•˜ê³  ê´€ë¦¬**í•´ì•¼ í•˜ëŠ” ìƒí™©ì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤. localStorageëŠ” client sideì—ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì—, **ê´€ë ¨ëœ ì»´í¬ë„ŒíŠ¸ë¥¼ csr í˜•ì‹ìœ¼ë¡œ ë§Œë“¤ê³  ê´€ë ¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì´ë¥¼ í˜¸ì¶œí•˜ì—¬ ì‚¬ìš©**ì„ í–ˆìŠµë‹ˆë‹¤.

```tsx
'use client';
import { useLocalStorage } from '@uidotdev/usehooks';
import { useRouter } from 'next/navigation';
import { ChangeEvent, useState } from 'react';
import { postUser } from '@/api/clientApi';
import { PATH, VISITED, GENDER } from '@/config';

export default function ChoiceSex() {
  const [sex, setSex] = useState<Gender>(GENDER.man);
  const [nickname, setNickName] = useState('');
  const [, saveToken] = useLocalStorage<null | string>('token', null);
  const [, saveIsVisited] = useLocalStorage<null | { [key: string]: boolean }>(
    'isVisited',
    null,
  );
  const router = useRouter();

  const handleSubmit = async (e: ChangeEvent<HTMLFormElement>) => {
    e.preventDefault();
    if (nickname.trim() === '') alert('Nicknameì„ ì‘ì„±í•´ì£¼ì„¸ìš”!');

    const jwt = await postUser(nickname, sex);

    if (jwt) {
      saveToken(jwt.token);
      saveIsVisited(VISITED);
      router.push(PATH.chatingList);
    } else alert('token ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  };
}
```

ì´ë•Œ í•´ë‹¹ í”„ë¡œì íŠ¸ë¥¼ buildí•˜ëŠ” ê³¼ì •ì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

```bash
[=   ] - info Generating static pages (3/5)
Error occurred prerendering page "/". Read more: https://nextjs.org/docs/messages/prerender-error
Error: useLocalStorage is a client-only hook
    at getLocalStorageServerSnapshot (C:\Users\name\Desktop\Github\mbtmi\client\.next\server\chunks\824.js:12804:9)
    at Object.useSyncExternalStore (C:\Users\name\Desktop\Github\mbtmi\client\node_modules\next\dist\compiled\react-dom\cjs\react-dom-server.edge.production.min.js:110:195)
    at exports.useSyncExternalStore (C:\Users\name\Desktop\Github\mbtmi\client\node_modules\next\dist\compiled\react\cjs\react.production.min.js:29:469)
    at useLocalStorage (C:\Users\name\Desktop\Github\mbtmi\client\.next\server\chunks\824.js:12810:52)
    at useRedirectIfKeyExists (C:\Users\name\Desktop\Github\mbtmi\client\.next\server\app\page.js:632:56)
    at Home (C:\Users\name\Desktop\Github\mbtmi\client\.next\server\app\page.js:665:23)
    at jg (C:\Users\name\Desktop\Github\mbtmi\client\node_modules\next\dist\compiled\react-dom\cjs\react-dom-server.edge.production.min.js:117:273)
    at Z (C:\Users\name\Desktop\Github\mbtmi\client\node_modules\next\dist\compiled\react-dom\cjs\react-dom-server.edge.production.min.js:124:91)
    at jg (C:\Users\name\Desktop\Github\mbtmi\client\node_modules\next\dist\compiled\react-dom\cjs\react-dom-server.edge.production.min.js:118:9)
    at jg (C:\Users\name\Desktop\Github\mbtmi\client\node_modules\next\dist\compiled\react-dom\cjs\react-dom-server.edge.production.min.js:123:11)

```

í•´ë‹¹ ì˜¤ë¥˜ëŠ” Next.jsì˜Â `Prerender Error`ì…ë‹ˆë‹¤. **pre-renderingì€ Next.jsê°€ JSë¡œ ë§Œë“  í˜ì´ì§€ë¥¼ ë³´ì—¬ì£¼ê¸° ì „ ê° í˜ì´ì§€ì˜ HTML íŒŒì¼ì„ ë¯¸ë¦¬ ë§Œë“¤ì–´ì„œ ë³´ì—¬ì£¼ëŠ” ê²ƒì„ ì˜ë¯¸**í•©ë‹ˆë‹¤. ì¦‰ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì œê³µí•˜ëŠ” useLocalStorageë¥¼ ì ìš©í•˜ëŠ” ê³¼ì •ì—ì„œ ì—ëŸ¬ê°€ ë°œìƒí–ˆë‹¤ëŠ” ë©”ì‹œì§€ì…ë‹ˆë‹¤. **useLocalstorageëŠ” ClientSideì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ë°, ì •ì  í˜ì´ì§€ë¥¼ ìƒì„±í•˜ëŠ” ê³¼ì •ì— ì´ë¥¼ Serversideì—ì„œ ì²˜ë¦¬ í•˜ë ¤ê³  í•˜ì—¬ ë°œìƒí•œ ë¬¸ì œ**ì…ë‹ˆë‹¤. **í•´ë‹¹ ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ mount ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë‹¨ê³„ë¥¼ ì¶”ê°€**í–ˆìŠµë‹ˆë‹¤.

```tsx
const [hasMounted, setHasMounted] = useState(false);

useEffect(() => {
  setHasMounted(true);
}, []);

if (hasMounted) {
  return [storedValue, setValue] as const;
}

return [initialValue, setValue] as const;
```

### ì „ì²´ ì½”ë“œ

```tsx
'use client';
import { useEffect, useState } from 'react';

/**
 * @description í˜ì´ì§€ ìƒˆë¡œ ê³ ì¹¨ì„ í†µí•´ ìƒíƒœê°€ ìœ ì§€ë˜ë„ë¡ ë¡œì»¬ ì €ì¥ì†Œì— ë™ê¸°í™”í•©ë‹ˆë‹¤.
 *
 * @param key ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥ë  í‚¤
 * @param initialValue ì´ˆê¸° ê°’
 * @returns [storedValue, setValue] - ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥ëœ ê°’, ì €ì¥ í•¨ìˆ˜
 */
function useLocalStorage<T>(key: string, initialValue: T) {
  // State to store our value
  // Pass initial state function to useState so logic is only executed once
  const [storedValue, setStoredValue] = useState<T>(() => {
    if (typeof window === 'undefined') {
      return initialValue;
    }
    try {
      const item = window.localStorage.getItem(key);

      return item ? JSON.parse(item) : initialValue;
    } catch (error) {
      console.error(error);

      return initialValue;
    }
  });

  const setValue = (value: T | ((val: T) => T)) => {
    try {
      const valueToStore =
        value instanceof Function ? value(storedValue) : value;
      setStoredValue(valueToStore);
      if (typeof window !== 'undefined') {
        window.localStorage.setItem(key, JSON.stringify(valueToStore));
      }
    } catch (error) {
      console.error(error);
    }
  };

  const [hasMounted, setHasMounted] = useState(false);

  useEffect(() => {
    setHasMounted(true);
  }, []);

  if (hasMounted) {
    return [storedValue, setValue] as const;
  }

  return [initialValue, setValue] as const;
}

export default useLocalStorage;
```

## localstorage ì‚¬ìš©ì„ ë°°ì œí•˜ì

Next.jsì—ì„œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ì€ ìƒê°ë³´ë‹¤ ê¹Œë‹¤ë¡œì› ìŠµë‹ˆë‹¤. CSRê³¼ SSRì„ êµ¬ë¶„í•˜ì—¬, **CSR ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‘ì—…ì„ ì§„í–‰**í•´ì•¼ í–ˆìŠµë‹ˆë‹¤. ë”ë¶ˆì–´ useLocalStorge hookì„ í™œìš©í•˜ê²Œ ë˜ë©´, í•´ë‹¹ hookì´ mountë˜ëŠ” ê²ƒì„ ê¸°ë‹¤ë ¤ì•¼ í–ˆê¸°ì—, **í•œë²ˆ ë” useEffect()ë¥¼ í™œìš©í•´ì„œ localstorage ë™ê¸°í™” ì‘ì—…ì´ ì´ë£¨ì–´ì§€ëŠ” í™˜ê²½ì„ ë³´ì¥**í•´ì£¼ì–´ì•¼ í–ˆìŠµë‹ˆë‹¤.

Next.jsì˜ ê°€ì¥ í° ì¥ì ì€ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì²˜ë¦¬í•´ì•¼ í•˜ëŠ” ì‘ì—…ì„ ì„œë²„ì—ê²Œ ìœ„ì„í•˜ì—¬ SEOì™€ ë Œë”ë§ ì†ë„ë¥¼ í–¥ìƒ ì‹œí‚¤ëŠ” ê²ƒìœ¼ë¡œ ìƒê°í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ì ì—ì„œ localstorageë¥¼ í™œìš©í•´ì•¼ í•œë‹¤ë©´, í•´ë‹¹ ë°ì´í„°ì˜ êµ¬ì¡°ë¥¼ ë‹¤ì‹œê¸ˆ ê³ ë¯¼í•´ë³´ì•„ì•¼ í•  ê²ƒ ê°™ìŠµë‹ˆë‹¤.

í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í•˜ëŠ” jwtì—ëŠ” ë¯¼ê°í•œ ì •ë³´ ì—†ì´, ì‚¬ìš©ìê°€ í•´ë‹¹ í˜ì´ì§€ì—ì„œì˜ ë‹µì•ˆ ì‘ì„± ì—¬ë¶€ë§Œì„ ê²€ì‚¬í•˜ê¸° ìœ„í•´ ë°œê¸‰í•˜ëŠ” ìš©ë„ì…ë‹ˆë‹¤. í•´ë‹¹ ë¡œì§ì„ clientì¸¡ì´ ì•„ë‹Œ, ì„œë²„ ì¸¡ì—ì„œ í•˜ëŠ” ë°©ë²•ì„ ê³ ë¯¼í•  í•„ìš”ê°€ ìˆëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤.

## jwtë¥¼ í™œìš©í•´ì„œ api ìš”ì²­í•˜ê¸°

ì‚¬ìš©ìê°€ ë‹µë³€í•œ ì •ë³´ë¥¼ ì„œë²„ì—ì„œ ë°›ì•„ì˜¤ëŠ” ê³¼ì •, ë‹µë³€ì„ ìƒì„±í•˜ëŠ” ê³¼ì •ì—ì„œ jwt ê°’ì´ í•„ìš”í–ˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ localStorageì— ì €ì¥ëœ token ê°’ì´ ìˆì„ ê²½ìš°ì—ë§Œ ìš”ì²­ì„ í•´ì•¼ í•©ë‹ˆë‹¤. ë”°ë¼ì„œ useEffectë¥¼ í™œìš©í•´ì„œ tokenê°’ì´ mount ëœ ê²½ìš°ì—ë§Œ ë°ì´í„° ìš”ì²­ì„ í•´ì•¼ í•©ë‹ˆë‹¤.

ì´ë•Œ ì˜ë„í•˜ì§€ ì•Šì€ í˜ì´ì§€ ë³€ê²½ì„ ìœ ì €ì—ê²Œ ë…¸ì¶œ ì‹œí‚¤ì§€ ì•Šê¸° ìœ„í•´ì„œ loading í˜ì´ì§€ë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤. ë°ì´í„°ê°€ ëª¨ë‘ fetch ëœ ì´í›„ì— í˜ì´ì§€ë¥¼ ë³¼ ìˆ˜ ìˆë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤.

```tsx
'use client';

import { useState, useEffect } from 'react';
import { getApiWhitToken } from '@/api/clientApi';
import { END_POINT } from '@/api/url';
import { QUESTIONS } from '@/data/question';
import useLocalStorage from '@/hooks/useLocalStorage';
import useRedirect from '@/hooks/useRedirect';
import { AnswerData, Data, UserInfo } from '@/types/types';
export default function useGetTokenAndVisited(): [
  boolean,
  Data[],
  UserInfo,
  string,
] {
  const [isLoading, setIsLoading] = useState(true);
  const [token] = useLocalStorage<null | string>('token', null);
  const [visited] = useLocalStorage<null | { [key: string]: boolean }>(
    'isVisited',
    null,
  );
  const [questions, setQuestion] = useState<Data[]>([]);
  const [userInfo, setUserInfo] = useState<UserInfo>({
    gender: 'man',
    nickname: 'person',
  });

  useRedirect(token, visited);
  useEffect(() => {
    if (token && visited) {
      getApiWhitToken<AnswerData>(END_POINT.getAnswerVisiting, token!).then(
        data => {
          const questions = QUESTIONS.map(question => {
            question.visited = visited[question.id];
            const answers = data?.answer[question.id];
            question.answer = [...answers!];
            if (data?.user.gender) {
              setUserInfo(data.user);
            }
            return question;
          });

          questions.sort((a, b) => {
            return a.visited === b.visited ? 0 : a.visited ? 1 : -1;
          });

          setQuestion(questions);
          setIsLoading(false);
        },
      );
    }
  }, [token, visited]);

  return [isLoading, questions, userInfo, token!];
}
```

ë”ë¶ˆì–´ ë§Œì•½ tokenê°’ì´ ì‚­ì œë˜ì—ˆì„ ê²½ìš°ì— isLoadingì˜ ê°’ì´ ë³€ê²½ì´ ë˜ì§€ ì•Šê¸°ì—, Lodaing í˜ì´ì§€ ë§Œì„ ì‚¬ìš©ìê°€ ë³´ê²Œ ë˜ëŠ” ìƒí™©ì´ ë°œìƒí•©ë‹ˆë‹¤. ë”°ë¼ì„œ token ê°’ì´ ì œê±° ë˜ì—ˆì„ ê²½ìš°ì—ëŠ” ê°•ì œë¡œ ìœ ì €ë¥¼ ì‹œì‘ í˜ì´ì§€ë¡œ ì´ë™ì‹œì¼œì•¼ í–ˆìŠµë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ì„œ **useEffectì™€ setTimeOutì„ ì¡°í•©**í•˜ì˜€ìŠµë‹ˆë‹¤. **ì¼ì • ì‹œê°„ì´ ê²½ê³¼í•œ í›„ì— í•´ë‹¹ í˜ì´ì§€ì—ì„œ token ê°’ì„ ì°¾ì„ ìˆ˜ ì—†ì„ ê²½ìš°, ìœ ì €ê°€ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ë„ë¡ êµ¬ì„±**í•˜ì˜€ìŠµë‹ˆë‹¤.

```tsx
'use client';
import { useRouter } from 'next/navigation';
import { useEffect } from 'react';

export default function useRedirect(
  token: string | null,
  visited?: null | { [key: string]: boolean },
) {
  // page ì „í™˜í•˜ê¸°
  const router = useRouter();
  useEffect(() => {
    const id = setTimeout(() => {
      if (!token || !visited) {
        alert('ê¸°ë¡ëœ ì •ë³´ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤. ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•´ì£¼ì„¸ìš” ğŸ˜µâ€ğŸ’«');
        router.push('/');
      }
    }, 2000);

    return () => clearTimeout(id);
  }, [token, visited, router]);
}
```
